/* global describe, it */

const beacon = require('../index')

describe('beacon.current', function() {
  it('should return all expected values for a specific timestamp', function(done) {
    beacon.current(1493245860, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property('version', 'Version 1.0')
      res.should.have.property('frequency', 60)
      res.should.have.property('timeStamp', 1493245860)
      res.should.have.property('timeStampISO8601', '2017-04-26T22:31:00.000Z')
      res.should.have.property(
        'seedValue',
        '5367784CAC9A9D65264256A15BD3373F7C1982FFEB42B3B5427E3F5E358765E9E2474D6DCB0FC552DD3F4CF8AC3D169E1F31C12CCACD4765BCAE8AFDFC7448B9'
      )
      res.should.have.property(
        'previousOutputValue',
        'ABE8C2106EEE15255A43C752CBE33C833B16D7120CAED143D1005275DDD1E5F4E16F0B1DEB1A02D4169D8B116D8A66C6AB7A788607D343D9B7164069B5DE07D2'
      )
      res.should.have.property(
        'signatureValue',
        '07DF220FC6D4768EBE41B66535F72CAD7BDAFFB9B871F64BCBB817D2FC43E8DC49F60D79BDEA3D9F39F80DA57B23E246806C4ECBA5FE76DE4EAA3E1F06B328FD34AA3369367CFAA5046C793E633C12B37C9834FDDB181BFCE252C130817991987669175E6E331179ABDB3264A6EF6A3145860B35257F49E244F18F6D9371935BB812B503FBE9A73FAE852514D396877817C9592535FAF42D596BF339AFD37263DA1C8E3DCEDE5C8D13C68EC2CB455E4ABF3C4E8769D44801B167362ACFE3117584DE3B23AA558F22D1358BAE7BA3CC2B73DFB3457DBCF66DBB9898880FC5AF906EA7E595FAC1E5F359A731935735E52F36186DACA904819D0C217351B8A97681'
      )
      res.should.have.property(
        'outputValue',
        '46D88151C915BD3DD65F0401BB7775D55AB0731170262084A20030C00C0A66D8DAA693E49DCE61F86C7AD176CC0EBEB1338ED0DA6A69994711C39718C98C4BDF'
      )
      res.should.have.property('statusCode', 0)
      res.should.have.property('validSignature', true)
      done()
    })
  })

  // Handle NIST Signature Issues Gracefully
  // See : https://github.com/urda/nistbeacon/issues/26

  // Good signature boundary
  it('should validate signature with last known good timestamp', function(done) {
    beacon.current(1495837080, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property(
        'signatureValue',
        '4E492DD12EF7D10867F2BBECDD783B3143FB284E71B43C255939ACF0C1897BCAC01A7140564D97572479EADEF958595A4B253948475FC941B9A22CE22287404E79F72B3BFE6332688F3E403E6A8941ECF019962CBB8C5D6235DD26029C4FCD4C0936EEA7CBF521F2DE114054323D1A07740EF207C422C8F44FA0978572A8E396BF8037CDA6A83FFEE7FA04E114F14EFFEC9DCD3B4918520976F707E8EA318D18988CBF9C8890F3F33624673F357A666270336B47420AB69BC8E9F86694AB34834099C5D1BD8C71D4390869AF4275E3CAC95618FDBC1A6238FD34CCFA6A132582E531219904ED34214059043D100595B5DF1844FB1D1D7D6F214EFDF391308657'
      )
      res.signatureValue.length.should === 512
      res.should.have.property('validSignature', true)
      done()
    })
  })

  // Broken signature boundary
  it('should not validate signature during the broken cert period', function(done) {
    beacon.current(1496176860, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property(
        'signatureValue',
        '77555F6F9AD9F835DAA52A333DC4EF6814329D48BFFD5409E839058927BA739F2460F1433BAB6291F74B07853F552DA9DE6F7B92649450795D2432504B277575DC55EF124EE666B1E5B04DBE35B192F0906384EDA7C081366A268A980F47F75565A7556D77DCFA7B1602B93A33E6A9AD918EB628BC88051284222A6174683F2D'
      )
      res.signatureValue.length.should === 256
      res.should.have.property('validSignature', false)
      done()
    })
  })

  // 8/8/2017 New good signature boundary
  it('should validate signature after 8/8/2017 using new pubkey.pem', function(done) {
    beacon.current(1494166740, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property(
        'signatureValue',
        '4FFD2AB40CAC8296025EC64F9BC67B8CE939A336CB311136D8979204C1EA83AE00A3EA667BC678648A46C411D62B70FF1E761FCF72D186DD3EFC5A9F0B4B458D5B133B8B84040833AA932DE51FE27507EF822D2ECD427AC87E24503D12CB8C74BAA87EAB596B66F3CA49F49B735728B1A1271C491269532DAD5D1C170371E80EAF8AC3D4637D8F11040DBFA86B5FD4010E8EBEA9286896FE2D5CFDD24E3221C8BF9EF512F8D018B769E900AA368EB68C2958A07B4515BB36DB2964A3204A8132F2D5186D7EAB6D470904A2568B1DBE5FCF98C0FEAF2F51130E6C7995FAD0E10079A973086985FDAB98B2CD9DB4E7516AF1BF1B5B8D606618D5D9B53D5B2B3266'
      )
      res.signatureValue.length.should === 256
      res.should.have.property('validSignature', true)
      done()
    })
  })

  // 8/21/2017 Current
  it('should validate signature weeks after 8/8/2017 using new pubkey.pem', function(done) {
    beacon.current(1503384720, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property(
        'signatureValue',
        '971D1E2FE862F88D5FA67A2AAA841723B02EF1A1EE4970EE5C210ACE98F7EC7182BAC67AE25FDA4D4E1C4B0732439A7D5819A7E1C49E6C3C4B2CCD5470939335271AFD4C97E3AF7CFBEB0EA9EB423AC9F6B2DFD8226013FB43035B25056ED7FD4ABC7FD81DCDC3FFF457FA60503001EC6F1241C446BEE8ABEC1E2CC81D8E17E4F1B2352ECFB1146C2D91E8D87F5074132CC80987B5EF1578D06AFCE8295760CFD1325FE052B03CF2B05F8C850006F960D8C15E04AB848034428700CDED364F67B8E1827B1E42EB480C201CB8C70B1D13D7ED26D4FC4F4D792516FAD5D7116C8022A8E79379ACBE790CDA0F1ED0717B2757EEA483E844A6FFA7D600BA0F3DD236'
      )
      res.signatureValue.length.should === 256
      res.should.have.property('validSignature', true)
      done()
    })
  })
})

describe('beacon.previous', function() {
  it('should return all expected values for a specific previous pulse', function(done) {
    beacon.previous(1494166740, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property('version', 'Version 1.0')
      res.should.have.property('frequency', 60)
      res.should.have.property('timeStamp', 1494166680)
      res.should.have.property('timeStampISO8601', '2017-05-07T14:18:00.000Z')
      res.should.have.property(
        'seedValue',
        '6FADA8886A8849D07F7B0EEAD52141FFE4663852884BC4B61D31C901F17B04FD17453CEE23E32D2670D946A10434E4BA6C6D060C7F7BAE35A0F9A8B629F40DED'
      )
      res.should.have.property(
        'previousOutputValue',
        '75C85E3EAD2C5F813C596A9EFD9AE4B4D87762C0E707C85293E433B81D20AD92CB7260BCC7E5F0AACE79DC0DBF7C2580D994D861CA5D3236D07503E3AC6E1EB6'
      )
      res.should.have.property(
        'signatureValue',
        '2FFD3734F3A511BC921828F5A32F04C526BDEAA44B6B2342EE0D77E5335407CEB4305EF686F6A99362E13BFA2DF1C3604BFBA4C45CDE5FD9F33E4C4636246DF3DFDA729DB77229D97ABB9526C58D9A1F00C0C849564B2366451F3AB0571A36BBFBB61CD1FD089BEB520A01E6FA40EF0A5401BBC48FA0669535986436B2EA11BE23230225CE229710C4B57D041B18E5215058D97B23C04D035FB7F89EC3BBE08BF702276E9E20983B6E5AEAABAB793A700968D9031CA4C0CDFDF5BC0805F6C385442573B716F6C21E6B7E40C1A4E683FFF2F4FDE9D31FAEE0796790504A72BE85CD8E4FE6A7E3FBB6423D74E3315B607A7210C4BA5ADC7D12A9E10C787A491054'
      )
      res.should.have.property(
        'outputValue',
        '29DA3AC0491B296FDCD7FB5433ECEBCF965EA10207D7A33476B1845CE05F8305F23BD38508D59F04C54A1972635A726072CC2E48DF6260951D314388FEEAB088'
      )
      res.should.have.property('statusCode', 0)
      res.should.have.property('validSignature', true)
      done()
    })
  })
})

describe('beacon.next', function() {
  it('should return all expected values for a specific next pulse', function(done) {
    beacon.next(1494166740, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property('version', 'Version 1.0')
      res.should.have.property('frequency', 60)
      res.should.have.property('timeStamp', 1494166800)
      res.should.have.property('timeStampISO8601', '2017-05-07T14:20:00.000Z')
      res.should.have.property(
        'seedValue',
        'E195AB64FEDA7AC17BB24A143FBF02D9127EBD650A00A0B3A8DC191074827159D34DD6BC35194909FF1054A3156F587979D8A700983301D16BD7260D1F8AADB1'
      )
      res.should.have.property(
        'previousOutputValue',
        '01BE623A11E19BA6C4FA9078A531FBE74B71AA8D64A99F1303698DF8B7712F30AB689AE92E6ADDD45D1155542DF0C9E5B2748B09286CB0A4EF19B47B726522E9'
      )
      res.should.have.property(
        'signatureValue',
        '039B670E37AE2562ACA007EE3F6BA26F02F1047AB95376603BC735AAB729C57056C4775876BBE301B2F3C64DAFDAAF1525FCDC4481CE045CDCB70FB159731FE502B4CA9C557B5012A5E0DAC45A00A495F2C44FC6ABE2079006A3396C3EBB54D07B32BB92257F3E17B1E873E1A8868F16D6A5EE5C13CA936792BE0F48371D7E08732B99398150F46204F3713E2DC1DABDE6259E9828D0B85989BEDB508508C20E328F37B03CE7B228CC1287CF9201E9C39C5D7A90DB8977E2ECF61B38E51BC6C41517D5636BE2CB13E7FA00353C1C8FA5358E0749DBDB0777C22F05D46A25295CBA02C29912BF885EAE6FD0C9717EEB7F905091107E0BE84072965056BABE079A'
      )
      res.should.have.property(
        'outputValue',
        '51E76422503BCAF38659D98CFA4EE2D63DCCD1646405CA4FFE068EA48995DC23016EA701AF391EC125109BED04EF2F9B0B29C546BB970C7E28654DCA17AD8012'
      )
      res.should.have.property('statusCode', 0)
      res.should.have.property('validSignature', true)
      done()
    })
  })
})

describe('beacon.startChain', function() {
  it('should return all expected values for first pulse', function(done) {
    // Why we have to add 1 to the timestamp value returned to retrieve?
    beacon.startChain(1378395541, function(err, res) {
      if (err !== null) done(err)
      res.should.have.property('version', 'Version 1.0')
      res.should.have.property('frequency', 60)
      res.should.have.property('timeStamp', 1378395540)
      res.should.have.property('timeStampISO8601', '2013-09-05T15:39:00.000Z')
      res.should.have.property(
        'seedValue',
        '87F49DB997D2EED0B4FDD93BAA4CDFCA49095AF98E54B81F2C39B5C4002EC04B8C9E31FA537E64AC35FA2F038AA80730B054CFCF371AB5584CFB4EFD293280EE'
      )
      res.should.have.property(
        'previousOutputValue',
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
      )
      res.should.have.property(
        'signatureValue',
        'F93BBE5714944F31983AE8187D5D94F87FFEC2F98185F9EB4FE5DB61A9E5119FB0756E9AF4B7112DEBF541E9E53D05346B7358C12FA43A8E0D695BFFAF193B1C3FFC4AE7BCF6651812B6D60190DB8FF23C9364374737F45F1A89F22E1E492B0F373E4DB523274E9D31C86987C64A26F507008828A358B0E166A197D433597480895E9298C60D079673879C3C1AEDA6306C3201991D0A6778B21462BDEBB8D3776CD3D0FA0325AFE99B2D88A7C357E62170320EFB51F9749B5C7B9E7347178AB051BDD097B226664A2D64AF1557BB31540601849F0BE3AAF31D7A25E2B358EEF5A346937ADE34A110722DA8C037F973350B3846DCAB16C9AA125F2027C246FDB3'
      )
      res.should.have.property(
        'outputValue',
        '17070B49DBF3BA12BEA427CB6651ECF7860FDC3792268031B77711D63A8610F4CDA551B7FB331103889A62E2CB23C0F85362BBA49B9E0086D1DA0830E4389AB1'
      )
      res.should.have.property('statusCode', 1) // start of chain record
      res.should.have.property('validSignature', true)
      done()
    })
  })
})

describe('beacon.last', function() {
  it('should return all expected values for last pulse', function(done) {
    beacon.last(function(err, res) {
      if (err !== null) done(err)
      res.should.have.property('version', 'Version 1.0')
      res.should.have.property('frequency', 60)
      res.should.have.property('statusCode', 0)
      res.should.have.property('validSignature', true)
      done()
    })
  })
})
